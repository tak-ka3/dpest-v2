# DP-Finder: サンプリングと最適化による差分プライバシー違反検出

**出典**: Bichsel, B., Gehr, T., Drachsler-Cohen, D., Tsankov, P., & Vechev, M. (2018). DP-Finder: Finding Differential Privacy Violations by Sampling and Optimization. *ACM CCS 2018*.

## 手法の概要

DP-Finderは、差分プライバシーアルゴリズムの実装が主張するプライバシー保証 $\varepsilon$ を満たしているかを検証し、違反がある場合には**最大のプライバシー損失を示す反例**を自動的に発見する手法です。従来手法（PSI等の記号的解析）が小規模な問題にしか適用できなかった課題に対し、サンプリングと数値最適化を組み合わせることで実用的な検証を実現します。

### 主要な特徴

1. **サンプリングベース推定**: モンテカルロサンプリングにより確率 $\Pr[F(x)\in\Phi]$ を推定
2. **相関サンプリング**: 隣接入力 $x, x'$ で同一の乱数を使用し分散を劇的に低減
3. **微分可能近似**: 非連続なプログラムをシグモイド関数等で滑らかに変換
4. **勾配ベース最適化**: SLSQP（逐次二次計画法）により違反度を最大化する反例を探索
5. **適応的サンプリング**: 信頼区間の幅に応じてサンプル数を動的に調整

### 主要コンポーネント

DP-Finderは以下のコンポーネントから構成されます：

1. **確率推定器**: 相関サンプリングによる $\Pr[F(x)\in\Phi]$ の推定
2. **信頼区間計算**: Hoeffding不等式、CLT、M-CLTに基づく誤差評価
3. **プログラム変換器**: ブール演算・条件分岐を微分可能関数に変換
4. **最適化エンジン**: $\hat{\epsilon}_d(x,x',\Phi)$ を最大化するSLSQP
5. **検証ツール**: PSIによる最終反例の厳密な確率計算

## 手法の詳細を説明するにあたって必要な知識

### 1. 差分プライバシーと違反の定義

**定義**: アルゴリズム $F: X \to Y$ が $\varepsilon$-差分プライバシーを満たすとは、任意の隣接入力 $(x, x') \in \mathit{Neigh}$ と任意の出力事象 $\Phi \subseteq Y$ について:

$$\Pr[F(x)\in\Phi] \leq \exp(\varepsilon) \cdot \Pr[F(x')\in\Phi]$$

**違反の検出**: 上記不等式を満たさない $(x, x', \Phi)$ を見つけることが目標。これは以下の最適化問題として定式化できます:

$$\max_{(x,x')\in\mathit{Neigh}} \epsilon(x,x',\Phi) \quad \text{where} \quad \epsilon(x,x',\Phi) = \log \frac{\Pr[F(x)\in\Phi]}{\Pr[F(x')\in\Phi]}$$

### 2. チェック関数とサンプリング

**チェック関数**: $\mathit{check}_{F,\Phi}(x) := [F(x)\in\Phi]$ （Iverson記号、真なら1、偽なら0）

**決定的チェック関数**: $i$ 番目の乱数シードで $F$ 内の確率的選択を固定した決定的プログラム $\mathit{check}^i_{F,\Phi}(x)$

**確率推定**:

$$\Pr[F(x)\in\Phi] \approx \Pr_D[F(x)\in\Phi] = \frac{1}{n}\sum_{i=1}^n \mathit{check}^i_{F,\Phi}(x)$$

### 3. 相関サンプリング（Correlated Sampling）

**アイデア**: $x$ と $x'$ で**同一の乱数シード**を使用することで、両者の出力を高度に相関させます。

**効果**:
- 独立サンプリング: 相関係数 $\rho \approx 0$
- 相関サンプリング: $\rho \approx 0.97$ ~ $0.999$

**分散低減**: 確率比 $\Pr[F(x)\in\Phi] / \Pr[F(x')\in\Phi]$ の推定分散が劇的に減少し、必要サンプル数が大幅に削減されます（Fig.6参照）。

### 4. 多次元中心極限定理（M-CLT）

**2次元正規近似**:

$$\left(\frac{1}{n}\sum_{i=1}^n S_i, \frac{1}{n}\sum_{i=1}^n S'_i\right) \approx \mathcal{N}_2\left((p,q), \frac{1}{n}\Sigma\right)$$

where $\Sigma$ は共分散行列（相関 $\rho$ を含む）

**比の分布**: Hinkleyの定理により、$R = \bar{S}/\bar{S}'$ の分布を解析的に記述し、$\epsilon = \log R$ の信頼区間を計算します。

### 5. プログラム変換ルール

非微分可能な演算を滑らかな関数に変換（$c$ は大きな定数、例: 50）:

| 元の演算 | 変換後の関数 |
|---------|-------------|
| `¬B` | $1 - B$ |
| `B1 && B2` | $B_1 \cdot B_2$ |
| `B1 \|\| B2` | $B_1 + B_2 - B_1 \cdot B_2$ |
| `E1 == E2` | $\exp(-c \cdot (E_1 - E_2)^2)$ |
| `E1 ≤ E2` | $\frac{1}{1 + \exp(-c \cdot (E_2 - E_1))}$ （シグモイド） |
| `if (B) x=E1 else x=E2` | $x := B \cdot E_1 + (1-B) \cdot E_2$ |

## DP-Finderの動作フロー

### ステップ1: 推定違反度の計算

#### (A) サンプリングとチェック関数の構築

1. **乱数シードの生成**: $n$ 個の独立な乱数シード $i=1,2,\dots,n$ を用意
2. **決定的チェック関数の作成**: 各シード $i$ について、$F$ 内の確率的選択を固定した決定的プログラム $\mathit{check}^i_{F,\Phi}(x)$ を生成
3. **相関サンプリングの適用**: $x$ と $x'$ に対し**同一の**シード $i$ を使用
   ```
   S_i := check^i_{F,Φ}(x)
   S'_i := check^i_{F,Φ}(x')
   ```

#### (B) 推定違反度の定義

$$\hat{\epsilon}(x,x',\Phi) = \log \frac{\frac{1}{n}\sum_{i=1}^n S_i}{\frac{1}{n}\sum_{i=1}^n S'_i}$$

**特殊ケース**:
- 分母が0（$x'$ 側で事象が発生しない）: $\epsilon = \infty$ → 即座に反例として返す
- 両方とも0: その $\Phi$ をスキップして別の候補を試す

### ステップ2: 信頼区間の計算

#### (A) Hoeffding不等式による厳密な信頼区間

**Hoeffdingの不等式**:

$$\Pr\left[\left|\frac{1}{n}\sum_{i=1}^n S_i - p\right| > \delta\right] \leq 2\exp(-2n\delta^2)$$

**誤差幅** $\Delta$ （信頼度 $1-\alpha$）:

$$\Delta = \sqrt{\frac{\ln(2/\alpha)}{2n}}$$

**$\epsilon$ の信頼区間**:

$$\left[\log\frac{p-\Delta}{q+\Delta}, \log\frac{p+\Delta}{q-\Delta}\right]$$

**特徴**:
- ✅ 厳密な保証（仮定なし）
- ❌ 保守的（区間幅が大きい）
- ❌ 高精度には非常に多くのサンプルが必要

#### (B) CLTに基づくヒューリスティック

**正規近似** （$n$ が大きい場合）:

$$\frac{1}{n}\sum_{i=1}^n S_i \approx \mathcal{N}\left(p, \frac{p(1-p)}{n}\right)$$

**誤差幅** （標準正規分布の $z_{1-\alpha/2}$ 点）:

$$\Delta' = z_{1-\alpha/2}\sqrt{\frac{\hat{p}(1-\hat{p})}{n}}$$

**特徴**:
- ✅ Hoeffdingより狭い区間
- ✅ 必要サンプル数が少ない
- ❌ $n$ が小さいと不正確

#### (C) M-CLT（多次元CLT）による最適化

**2次元正規分布の利用**:
1. サンプルペア $(S_i, S'_i)$ の経験的共分散行列 $\Sigma$ を計算
2. $(\bar{S}, \bar{S}') \approx \mathcal{N}_2((p,q), \frac{1}{n}\Sigma)$ を仮定
3. 比 $R = \bar{S}/\bar{S}'$ の分布をHinkleyの定理で計算
4. $\epsilon = \log R$ の信頼区間を2分探索で数値的に求める

**相関の活用**:
- 相関係数 $\rho$ が高い（0.97~0.999）ほど信頼区間が狭くなる
- Fig.6では、M-CLTが他手法より1桁以上少ないサンプルで目標精度を達成

**実験例** （$p\approx3.24\%, q\approx3.04\%, \rho=0.97$）:
- Hoeffding: 区間幅 $\approx 0.079$、$n=10^7$
- CLT: 区間幅 $\approx 0.025$、$n=10^7$
- M-CLT: 区間幅 $\approx 0.01$、$n < 10^7$

#### (D) 適応的サンプリング戦略

```
n ← 初期サンプル数（例: 1000）
repeat:
    新たにサンプルを追加して n を増加
    信頼区間幅 Δε を計算（M-CLT使用）
until Δε < 目標精度（例: 2×10^-3）
```

### ステップ3: 微分可能な目的関数への変換

#### (A) プログラム変換

元の $\mathit{check}^i_{F,\Phi}(x)$ は0/1の離散値を返す非微分可能なプログラム。これを滑らかな実数値関数 $\mathit{dcheck}^i_{F,\Phi}(x)$ に変換します。

**変換例**:
```python
# 元のコード
if (x[0] + noise >= threshold):
    output = True
else:
    output = False

# 変換後（微分可能）
cond = 1 / (1 + exp(-c * ((x[0] + noise) - threshold)))  # シグモイド
output = cond * 1.0 + (1 - cond) * 0.0
```

#### (B) 微分可能推定違反度

$$\hat{\epsilon}_d(x,x',\Phi) = \log \frac{\frac{1}{n}\sum_{i=1}^n \mathit{dcheck}^i_{F,\Phi}(x)}{\frac{1}{n}\sum_{i=1}^n \mathit{dcheck}^i_{F,\Phi}(x')}$$

**近似精度**:
- $c$ が大きい（例: 50）ほど元の関数に近づく
- 実験では $\hat{\epsilon}_d$ と $\hat{\epsilon}$ の値がかなり近いことを確認

### ステップ4: 最適化による反例探索

#### (A) 最適化問題の定式化

$$\max_{(x,x')\in\mathit{Neigh}} \hat{\epsilon}_d(x,x',\Phi) \quad \text{s.t.} \quad (x,x') \in \mathit{Neigh}$$

**使用アルゴリズム**: SLSQP（Sequential Least Squares Programming）
- 制約付き非線形最適化
- 勾配ベース（$\nabla_{x,x',\Phi} \hat{\epsilon}_d$ を利用）

#### (B) 多重初期化戦略

局所解の問題を緩和するため、$N$ 回（例: 50回）ランダムに初期点を選んで最適化を繰り返します:

```
for iteration = 1 to N:
    (x, x', Φ) ← ランダムに初期化
    サンプリングして推定違反度を計算
    信頼区間が十分狭くなるまでサンプル数を増加
    SLSQP で (x*, x'*, Φ*) ← argmax ε̂_d(x,x',Φ)
    if ε̂(x*, x'*, Φ*) > best_ε:
        best ← (x*, x'*, Φ*)
return best
```

#### (C) エッジケースの処理

**分母が0の場合** （$\Pr[F(x')\in\Phi] = 0$ かつ $\Pr[F(x)\in\Phi] > 0$）:
- $\epsilon = \infty$ （無限大のプライバシー違反）
- 最適化を行わず即座にその反例を返す

### ステップ5: 検証フェーズ

最適化で得られた反例候補 $(x^*,x'^*,\Phi^*)$ について、厳密な違反度を確認します。

#### (A) PSIによる記号的確率計算

**PSI（Probabilistic Symbolic Inference）**: 確率的プログラムの分布を記号的に計算するツール

**具体的入力に対する計算**:
```
P_exact = PSI(check_{F,Φ}, x*)
Q_exact = PSI(check_{F,Φ}, x'*)
ε_verified = log(P_exact / Q_exact)
```

**適用範囲**:
- ✅ 具体的な $x, x'$ に対しては高速（数秒）
- ❌ 記号的な一般解を求めるのは困難（6時間以上）

#### (B) PSIタイムアウト時の代替手段

PSIが計算できない場合、非常に大きなサンプル数（例: $10^8$）でHoeffding不等式に基づく厳密な信頼区間を計算します。

**著者らの実験**: 全ベンチマークでPSIがタイムアウトせず検証成功

## 実験結果

### 対象アルゴリズム

| アルゴリズム | 公称 ε | 説明 |
|------------|-------|------|
| AT (Above Threshold) | 0.1 | 閾値超過判定の基本アルゴリズム |
| AT1 ~ AT4 | 0.1 ~ 0.175 | ATの変種（ノイズスケール等を変更） |
| AT5 | ∞ | ノイズなし変種（非プライベート） |
| ExpMech | 0.1 | 指数メカニズム |
| NoisyMax | 0.5 | 最大値選択 |
| Sum | 0.2 | 集計値の公開 |

### 違反度の比較（Fig.12）

**DP-Finder vs ランダム探索** （中央値での改善倍率）:

| アルゴリズム | 改善倍率 |
|------------|---------|
| AT4 | 2倍 |
| AT3 | 5倍 |
| NoisyMax | 12倍 |
| Sum | **33倍** |

**結論**: DP-Finderはランダム探索より遥かに高い違反度の反例を発見

### 理論上限値との比較

**ExpMech**: 発見された違反度が理論上限にほぼ一致 → 上限が**tight**（実際に達成されている）

**AT系列**: 一部で上限値と下限値にギャップ
- (a) 上限が緩すぎる可能性（改善の余地）
- (b) DP-Finderがまだ最悪ケースを見つけきれていない

### 処理時間の内訳（Fig.13）

**1イテレーション当たりの平均時間**: 5分以内

**時間配分**:
- 最適化（SLSQP）: 70-80%
- サンプリング: 10-20%
- PSI検証: 5-10%

### サンプル数の変動（Fig.14）

**範囲**: $10^4$ ~ $10^7$ サンプル（アルゴリズムと反例候補に依存）

**適応的サンプリングの効果**: 必要な場合にのみサンプル数を増やすことで効率化

## 他手法との比較

### PSI直接解法との比較

| 項目 | PSI直接解法 | DP-Finder |
|------|-----------|-----------|
| 確率計算 | 記号的（厳密） | サンプリング（近似） |
| 最適化 | Mathematica | SLSQP（数値） |
| 配列サイズ2 | 6時間でも解けず | 数分 |
| 配列サイズ4 | タイムアウト（6時間） | 5分以内 |
| スケーラビリティ | ❌ 極めて限定的 | ✅ 実用的 |

### StatDPとの比較

| 項目 | StatDP | DP-Finder |
|------|--------|-----------|
| アプローチ | 統計的仮説検定 | 最適化ベース探索 |
| 出力 | 違反検出（p値） | 最大違反度 + 反例 |
| 探索戦略 | イベント選択 + パターンベース入力 | 勾配ベース連続最適化 |
| 反例の質 | 検出可能な反例 | **最悪ケース**に近い反例 ⭐ |
| 実行時間 | 数秒〜数分 | 数分（1イテレーション） |
| 適用範囲 | 広範（ブラックボックス） | 微分可能に変換可能なプログラム |

**DP-Finderの優位性**:
- 最大違反度の探索に特化（攻撃者視点）
- 連続最適化により広い探索空間をカバー
- 相関サンプリング + M-CLTで高効率

**DP-Finderの制限**:
- プログラム変換が必要（無限ループ等は非対応）
- 局所最適解に陥る可能性（多重初期化で緩和）

### CheckDPとの比較

| 項目 | CheckDP | DP-Finder |
|------|---------|-----------|
| 目的 | 証明 OR 反例 | 反例のみ |
| 手法 | ランダムネスアラインメント合成 | サンプリング + 最適化 |
| 実行時間 | 15-70秒 | 5分以内/イテレーション |
| 反例精度 | 厳密（PSI検証） | 厳密（PSI検証） |
| 証明能力 | ✅ あり | ❌ なし |
| 探索効率 | テンプレート制約内 | 連続空間全体 |

## まとめ

DP-Finderは、**サンプリングと数値最適化**を統合することで、差分プライバシー違反の最悪ケースに近い反例を効率的に発見する画期的な手法です。相関サンプリングとM-CLTによる分散低減、プログラム変換による微分可能近似、SLSQPによる勾配ベース探索を組み合わせることで、従来の記号的解析では不可能だった規模の問題に対応できます。

**主な貢献**:
1. 相関サンプリングによる劇的な分散低減（$\rho \approx 0.97$~$0.999$）
2. M-CLTに基づく効率的な信頼区間推定
3. ブール演算・条件分岐の微分可能変換ルール
4. PSI検証との統合による厳密性の保証
5. 既存手法（ランダム探索）より2~33倍高い違反度を発見

**適用場面**:
- 新規アルゴリズムのプライバシー評価
- 既存理論の厳密性テスト
- 攻撃者が最大漏洩を探す状況のシミュレーション
