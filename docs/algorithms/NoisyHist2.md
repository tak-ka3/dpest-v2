# NoisyHist2

## アルゴリズムの説明

NoisyHist2は、NoisyHist1の **誤った実装** です。Laplaceノイズのスケールパラメータが誤って設定されており、 $10\varepsilon$ -差分プライバシーとなっています（意図した $\varepsilon$ -差分プライバシーではない）。

**出典**:
> Zeyu Ding, Yuxin Wang, Guanhong Wang, Danfeng Zhang, and Daniel Kifer. 2018.
> Detecting Violations of Differential Privacy. CCS 2018.
> Algorithm 10

**アルゴリズム**:
1. 入力ヒストグラム $h = (h_1, h_2, \ldots, h_m)$ を受け取る
2. 各ビン $i$ に対して、独立にLaplaceノイズ $\eta_i \sim \text{Lap}(\varepsilon)$ を追加（**誤り**: 正しくは $\text{Lap}(1/\varepsilon)$ ）
3. ノイズ付きヒストグラム $(h_1 + \eta_1, h_2 + \eta_2, \ldots, h_m + \eta_m)$ を出力

**数式**:

$$
M(D) = (h_1 + \text{Lap}(\varepsilon), h_2 + \text{Lap}(\varepsilon), \ldots, h_m + \text{Lap}(\varepsilon))
$$

**プライバシー保証**: このアルゴリズムは ** $(1/\varepsilon)$ -差分プライバシー** を満たします。
- 意図: $\varepsilon = 0.1$ → 0.1-DP
- 実際: $\varepsilon = 0.1$ → $(1/0.1) = 10$ -DP（**100倍弱い**）

## モード

**解析モード**

各ビンに対してLaplace分布を格子近似し、 $m$ 個の独立な畳み込み演算を並列実行します。

## プライバシー損失結果

| 項目 | 値 |
|------|-----|
| 入力サイズ | 5 |
| 推定 ε | 10.0001 |
| 理論 ε | 10.00 |
| 誤差 | +0.0001 (0.001%) |
| 実行時間 | 0.01秒 |

**データソース**: `docs/privacy_loss_report.md`

**解釈**: DPESTは、このアルゴリズムのプライバシー損失が理論値10.0（意図した0.1ではない）であることを **正確に検出** しています。

## 理論的な計算量

### 解析モード

**全体計算量**: $O(m \times g \log g)$ **内訳**:
1. **Laplace分布の生成**: $O(m \times g)$ - $m=5$ 個の独立なLaplace分布を生成
   - スケールパラメータ $b = \varepsilon = 0.1$ （**小さい** → 分布が狭い）
2. **Add演算（各ビンに対する畳み込み）**: $O(m \times g \log g)$ - $m=5$ 回の独立な畳み込み
   - 各畳み込みは $O(g \log g)$ （FFTベース）

**NoisyHist1との違い**:
- 計算量は同じ $O(m \times g \log g)$ - ただし、Laplaceスケールが $b = 0.1$ と小さいため、分布の幅が狭い
  - サポート範囲が短い → 格子が密に配置される → 精度が向上
  - 切断誤差が大きくなる可能性があるが、 $R$ を適応的に調整

**実効計算量**（ $m=5$ , $g=1000$ ）:

$$
5 \times 1000 \times \log_2(1000) \approx 5 \times 10^4 \text{ 演算}
$$

**メモリ使用量**: $O(m \times g) = O(5000)$ **参照**: `docs/OPERATION_COMPLEXITY_ANALYSIS.md`
- Add演算（連続+連続）: 1.1.3節

## 理論的な誤差（精度）

### 解析モードの誤差構造

NoisyHist1と同様の誤差構造ですが、スケールパラメータが小さいため、誤差特性が異なります。

#### 1. 切断誤差（Truncation Error）

$$
\text{err}_{\text{trunc}} \approx e^{-R/b} = e^{-R/0.1} = e^{-10R}
$$

- スケール $b = 0.1$ が小さいため、同じサポート範囲 $R$ では切断誤差が **大きい**
- 対策: $R$ を適応的に調整（ $R = 50b = 5$ で十分）

#### 2. 補間誤差（Interpolation Error）

$$
\text{err}_{\text{interp}} = O(1/g^2) = O(10^{-6})
$$

#### 3. 数値積分誤差（Quadrature Error）

台形則による誤差:

$$
\text{err}_{\text{quad}} = O(L^3/g^2)
$$

- 積分範囲 $L \approx 100b = 10$ （NoisyHist1の $L=1000$ より **100倍短い**）
- 誤差: $O(10^3/10^6) = O(10^{-3})$ **総誤差**: NoisyHist1と同程度（ $O(10^{-3})$ ）ですが、積分範囲が短いため、**精度が向上**する傾向があります。

## 理論と実験結果の比較分析

### 精度の分析

| 項目 | 理論値 | 実測値 | 差分 |
|------|--------|--------|------|
| ε | 10.00 | 10.0001 | +0.0001 |
| 相対誤差 | - | 0.001% | - |

**評価**:
- 推定精度は **極めて高く**、理論値との誤差は0.001%のみ
- NoisyHist1（誤差0.2%）よりも **200倍精度が高い**
  - 理由: Laplaceスケールが小さい → 分布が狭い → 格子が密 → 数値誤差が小さい
- DPESTは、プライバシー違反（理論値10.0）を **正確に検出**

### 実行時間の分析

| 項目 | 理論値 | 実測値 | 評価 |
|------|--------|--------|------|
| 計算量 | $O(m \times g \log g)$ | - | - |
| 演算数（ $m=5$ ） | $\approx 5 \times 10^4$ | - | - |
| 実行時間 | - | 0.01秒 | 極めて高速 |

**評価**:
- NoisyHist1と同じ実行時間（0.01秒）を達成
- サポート範囲が短い（ $L=10$ vs $L=1000$ ）ため、理論上は **高速化の余地** があるが、実測では差が見られない
  - 理由: FFTのオーバーヘッドが支配的、または格子点数 $g$ が同じため
- DP-Sniperの実行時間（37秒）と比較して **3700倍高速**
- StatDPの実行時間（420秒）と比較して **42000倍高速**

### 比較: DP-Sniper vs StatDP vs DPEST

| 手法 | 推定 ε | 実行時間 | 相対速度 |
|------|--------|----------|----------|
| DP-Sniper | 4.604 | 37秒 | 1x |
| StatDP | 9.956 | 420秒 | 0.09x |
| DPEST | 10.0001 | 0.01秒 | **3700x** |

**結論**:
1. **精度**: DPESTは理論値10.0に最も近い（誤差0.001%）
   - DP-Sniper: 誤差54% (10.0 → 4.604) - **大きく過小評価**
   - StatDP: 誤差0.44% (10.0 → 9.956) - やや過小評価
   - DPEST: 誤差0.001% (10.0 → 10.0001) - **極めて正確**
2. **速度**: DPESTは他手法と比較して **3700-42000倍高速**
3. **プライバシー違反検出**: DPESTのみが理論値10.0を正確に検出し、プライバシー違反を確実に報告

### 解析モードの優位性

NoisyHist2は、プライバシー違反検出における解析手法の優位性を示します：

1. **高精度**: 誤差0.001%で理論値10.0を検出
2. **プライバシー違反の確実な検出**:
   - 意図: 0.1-DP
   - 実際: 10.0-DP（**100倍弱い**）
   - DPESTはこの違反を明確に検出
3. **サンプリング手法の限界**:
   - DP-Sniper: 4.604（54%誤差） - 違反を**過小評価**
   - StatDP: 9.956（0.44%誤差） - ほぼ正確だが、DPESTより劣る
4. **速度と精度の両立**: 0.01秒で極めて高精度な推定

**参照**: `docs/ANALYTIC_MODE_SUPERIORITY.md` - 解析モードの理論的優位性の詳細分析
