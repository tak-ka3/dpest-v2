# 依存関係を考慮した演算設計

本ドキュメントでは、入力の確率分布間に存在する依存関係を検出し、
必要に応じてサンプリングにフォールバックする仕組みについて説明する。

## 依存関係の識別

- `Dist` が生成される際にユニークな ID を発行し、`dependencies` セットに
  保存する。
- 既存の分布から派生した分布でもこのセットをコピーし、計算グラフ全体で
  依存 ID が伝播する。
- これにより、任意の分布オブジェクトがどの変数に由来するかを集合演算で
  判定できる。

## 計算グラフの走査

- 実際の計算を行う前に、計算グラフを上流から下流へ走査して各ノード
  (オペレーション) の入力 `dependencies` を調べる。
- 共有する ID が検出された場合、そのオペレーションでは入力変数が
  相関していると判断する。

## サンプリングへのフォールバック

- 依存があるオペレーションは、共有サンプラーから共同サンプルを生成して
  経験的な分布を構築する。
- 依存が無い場合は従来通り解析的なアルゴリズムを用いる。
- `Add` や `Affine`、`Max` `Min` `Argmax` などの演算がこの仕組みを利用する。

## 依存関係の伝播

- 各オペレーションの出力 `Dist` には、入力の `dependencies` セットの和集合
  が設定される。
- これにより後続の演算でも同じ依存チェックが行われ、必要に応じて
  サンプリングに切り替えられる。

