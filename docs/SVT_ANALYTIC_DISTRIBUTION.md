# Sparse Vector Technique の解析的分布計算

Sparse Vector Technique (SVT) ではしきい値にノイズを加えながらクエリを順に評価し、
真が最大 \(c\) 回出力された時点で機構を停止します。本ドキュメントでは
SVT の出力確率分布を解析的に求める方法と、`dist` と `joint_dist` の違いをまとめます。

## 1. しきい値とクエリへのノイズ付与

1. しきい値 \(t\) にラプラスノイズ \(\rho \sim \mathrm{Lap}(1/\varepsilon_1)\) を加え
   \(T = t + \rho\) の分布を得ます。
2. 各クエリ値 \(q_i\) に独立なノイズ \(\xi_i\) を加え
   \(V_i = q_i + \xi_i\) の分布を構成します。ノイズの尺度は SVT の亜種により異なります。

## 2. 比較結果の列挙

各クエリについて \(V_i \geq T\) の確率を計算し、結果が真 (1) か偽 (0) かの
二値分布を得ます。真が \(c\) 回出力された時点で機構はアボートし、
以降のクエリは値 \(-1\) を返したものとして扱います。

## 3. `joint_dist` の構成

全てのクエリについて真偽を列挙すると、長さ \(n\) の出力ベクトル
\((y_1,\ldots,y_n)\) の全てのシーケンスが得られます。それぞれのシーケンスに
対して発生確率を計算し、`Dist.from_atoms` でジョイント分布を作成します。
これが `svt*_joint_dist` 系の関数で実装されている処理です。

## 4. `dist` と `joint_dist` の違い

- `dist` 関数は各ステップの周辺分布を個別に返します。クエリ同士の依存関係を
  無視しており、プライバシー損失を評価する際に各座標の ε を単純に足し合わせると
  過大な上界になります。
- `joint_dist` は出力ベクトル全体のジョイント分布を返します。シーケンス全体を
  1 つの確率変数として扱うため、座標間の依存関係が保持され、より精密な
  プライバシー解析が可能です。

ジョイント分布から各ステップの周辺分布は簡単に復元できるため、
SVT では `dist` の実装を削除し `joint_dist` のみを提供しています。
周辺分布が必要な場合はジョイント分布の各シーケンスを集計して求めてください。

## 5. プライバシー損失の評価

`estimate_algorithm` に `joint_dist_func` を渡すことで、
隣接するデータセットの出力ベクトル分布 \(P,Q\) から直接 ε を計算できます。
ジョイント分布を用いることで、従来の周辺分布の単純合計よりも小さな
プライバシー損失が得られます。

