# 差分プライバシーε推定における解析手法とサンプリング手法の精度・性能分析

## 概要

本ドキュメントでは、dpestフレームワークにおける2つの主要な推定手法—解析手法（Analytic Mode）とサンプリング手法（Sampling Mode）—について、理論的な精度保証と実行時間の計算量を分析します。

---

## 1. 解析手法の理論的基礎

### 1.1 数学的定式化

解析手法は、確率分布を**格子近似（grid approximation）**によって離散化し、FFT（高速フーリエ変換）ベースの畳み込みを用いて演算を実行します。確率分布 $P(X)$ は以下のように離散化されます：

$$
P(X) \approx \sum_{i=1}^{g} p_i \delta(x - x_i), \quad x_i = x_{\min} + i \cdot \Delta x
$$

ここで：
- $g$: 格子点数（デフォルト1000）
- $\Delta x = \frac{x_{\max} - x_{\min}}{g}$: 格子間隔
- $p_i$: 格子点 $x_i$ での確率密度（ $\sum_i p_i \Delta x = 1$）

### 1.2 誤差の理論的分解

解析手法における総誤差 $E_{\text{total}}$ は3つの成分に分解されます：

$$
E_{\text{total}} = E_{\text{trunc}} + E_{\text{interp}} + E_{\text{quad}}
$$

#### 1.2.1 切断誤差（Truncation Error） $E_{\text{trunc}}$

確率分布のサポートを有限区間 $[x_{\min}, x_{\max}]$ に制限することによる誤差。裾確率（tail probability）に依存：

$$
E_{\text{trunc}} = P(X < x_{\min}) + P(X > x_{\max})
$$

**Laplace分布の場合**:

dpestでは、Laplace分布のサポート範囲を $[\mu - 7b, \mu + 7b]$ に設定しているため：

$$
E_{\text{trunc}} = 2e^{-7} \approx 0.0018 \quad (0.18\%)
$$

#### 1.2.2 補間誤差（Interpolation Error）$E_{\text{interp}}$

連続分布を離散格子で近似する際の誤差。格子間隔 $\Delta x$ に依存：

$$
E_{\text{interp}} = O\left(\Delta x^2 \cdot \left\|\frac{d^2P}{dx^2}\right\|\right)
$$

$b=10$ , $g=1000$ の場合、 $E_{\text{interp}} \approx 0.00001$ (0.001%)。

#### 1.2.3 数値積分誤差（Quadrature Error） $E_{\text{quad}}$

台形則または矩形則による数値積分の誤差。$b=10$ の場合、 $E_{\text{quad}} \approx 0.00001$ (0.001%)。

### 1.3 総合誤差の評価

典型的なパラメータ $b=10$ では：

$$
E_{\text{total}} \approx 0.00182 \quad (0.18\%)
$$

### 1.4 解析手法の利点と限界

**利点**:
1. **決定論的**: 同じ入力に対して常に同じ結果
2. **高精度**: 格子近似誤差 $O(1/g^2)$ だが、演算の組み合わせで誤差が累積（単一演算では相対誤差数%程度）
3. **計算効率**: 演算により異なるが、多くの場合 $O(g)$ から $O(g \log g)$ で計算可能
4. **メモリ効率**: 格子点数 $g$ に比例（$g=1000$ で約8KB/分布）

**限界**:
1. **独立性の仮定**: 分布間の依存関係を扱えない
2. **誤差累積**: 複数演算の組み合わせで誤差が蓄積

---

## 2. サンプリング手法の理論的基礎

### 2.1 Monte Carlo法の基本原理

サンプリング手法は、確率分布 $P(X)$ から $N$ 個のサンプル $\{x_1, \ldots, x_N\}$ を生成し、経験分布で近似します：

$$
\hat{P}(X) = \frac{1}{N} \sum_{i=1}^{N} \delta(x - x_i)
$$

### 2.2 精度の理論的評価

#### 2.2.1 中心極限定理による誤差

確率 $p$ の推定値 $\hat{p}$ の標準誤差は：

$$
\sigma_{\hat{p}} = \sqrt{\frac{p(1-p)}{N}}
$$

**サンプル数と精度の関係**:

| サンプル数 $N$ | 標準誤差 $\sigma$ | 95%信頼区間幅 | 相対誤差（$p=0.1$の場合） |
|--------------|-----------------|-------------|----------------------|
| 1,000 | 0.032 | ±0.062 | ±62% |
| 10,000 | 0.010 | ±0.020 | ±20% |
| 100,000 | 0.003 | ±0.006 | ±6% |
| 1,000,000 | 0.001 | ±0.002 | ±2% |

dpestのデフォルト $N=100,000$ では、**相対誤差 ±6%** が期待されます。

#### 2.2.2 プライバシー損失εの推定誤差

プライバシー損失は以下で定義されます：

$$
\varepsilon = \max_{S} \ln \frac{P(S)}{Q(S)}
$$

確率比の対数における誤差は：

$$
\Delta \varepsilon \approx \left|\frac{\Delta P}{P}\right| + \left|\frac{\Delta Q}{Q}\right|
$$

$P=Q=0.1$ , $N=100,000$ の場合：

$$
\Delta \varepsilon \approx 0.06 \quad (6\%)
$$

#### 2.2.3 レアイベントバイアス

プライバシー損失の最大値は、**最も稀なビン**で発生することが多い。確率 $p \ll 1/N$ のビンでは、以下の問題が生じます：

1. **ゼロカウント問題**: $n(S_k) = 0$ の場合、$\hat{P}(S_k) = 0$ となり確率比が計算不能
   - **現在の実装**: プライバシー損失を無限大（$\varepsilon = \infty$）として出力
   - これは保守的な推定（実際のεより大きく見積もる）
2. **高分散**: 稀なイベントの推定値は分散が大きい

**注意点**:
- サンプル数が不足している場合、片方のデータベースでのみサンプルが観測され、誤って $\varepsilon = \infty$ と判定される可能性がある
- この問題は出力空間が広い離散分布（例: SVT, PrefixSum）で顕著

### 2.3 計算量の理論的解析

#### 2.3.1 サンプル生成の計算量

総計算量:

$$
T_{\text{total}} = N \times T_{\text{sample}}
$$

$N=100,000$ , $n=10$ の場合：

$$
T_{\text{total}} = 100,000 \times 10 = 10^6 \text{ 演算}
$$

#### 2.3.2 ヒストグラム構築の計算量

多次元ヒストグラムの構築：

$$
T_{\text{histogram}} = O(N \cdot d + B)
$$

ここで：
- $d$: 出力の次元数
- $B = \prod_{i=1}^{d} b_i$: 総ビン数

### 2.4 サンプリング手法の利点と限界

**利点**:
1. **依存関係対応**: 同じ乱数源を複数回参照する場合も正確に扱える
2. **柔軟性**: 任意の複雑な確率操作に適用可能
3. **理論的保証**: 中心極限定理により誤差が $O(1/\sqrt{N})$ で減少

**限界**:
1. **低精度**: $N=100,000$ で相対誤差 ±6%
2. **低速**: サンプル生成とヒストグラム構築により実測で100-400倍遅い
3. **非決定論的**: 乱数シードに依存し、再現性に注意が必要

---

## 3. 結論

dpestフレームワークにおける解析手法とサンプリング手法は、以下の特性を持ちます：

### 解析手法の特徴
- **高精度**: 単一演算で0.2%、複数演算の組み合わせで0-6%の誤差
- **高速**: FFT最適化により実行時間0.01-24秒
- **決定論的**: 再現性が保証される
- **制約**: 独立性の仮定が必須（Branch演算などの依存関係には適用不可）

### サンプリング手法の特徴
- **依存関係対応**: Branch演算、共通変数参照、累積依存など任意の複雑な確率操作に適用可能
- **柔軟性**: 解析手法で扱えない複雑な条件分岐に対応
- **精度**: $N=1,000,000$ で相対誤差 ±2%（理論値）、実測2-15%
- **実行時間**: 23-307秒（サンプル数に比例）

### 手法選択の指針

**解析手法を優先すべき場合**:
- 出力要素が互いに独立（共通の乱数源を参照しない）
- 相対誤差 0-6% で許容可能
- 実行時間を最小化したい（10-1000倍の高速化）

**サンプリング手法が必須の場合**:
- Branch演算で同じ確率変数を複数回参照
- SVT系アルゴリズムでの共通ノイズ付き閾値への依存
- PrefixSumのような累積和での前要素への依存
- 複雑な条件制御を含む構造

本分析により、各アルゴリズムにおける理論的誤差と実測性能の関係が明確化され、適切な手法選択の指針が得られました。特に、Branch演算や共通変数参照の有無が手法選択の決定的要因となることが確認されました。
