# SVT2の確率分布計算

このドキュメントでは Sparse Vector Technique 2 (SVT2) の各出力確率変数の分布を解析的に求める手順を説明します。SVT2 はしきい値にラプラスノイズを加え、各クエリ値にもノイズを加えて比較します。真を出力した場合はしきい値を再サンプリングし、最大 \(c\) 回まで真を出力します。

## 1. しきい値分布の初期化 (Add)

- ノイズ \(\rho \sim \mathrm{Lap}(c/\varepsilon_1)\) を生成します。
- 定数しきい値 \(t\) と加算し、\(T = t + \rho\) の分布を `add_distributions` で計算します。
- この分布を各状態の基底しきい値として保持します。

## 2. クエリ値分布 (Add)

- 各クエリ値 \(q_i\) に独立なノイズ \(\xi_i \sim \mathrm{Lap}(2c/\varepsilon_2)\) を加えます。
- `add_distributions` により \(V_i = q_i + \xi_i\) の分布を求めます。

## 3. しきい値比較と条件付き更新 (CompareGEQ)

- 状態 \(k\) (これまでに \(k\) 回真を出力した) ごとにしきい値分布 \(T_k\) を保持します。
- `compare_geq` に相当する操作を数値積分で行い、真の確率
  \[ P(V_i \geq T_k) = 1 - \int f_{T_k}(x) F_{V_i}(x) \, dx \]
  を計算します。
- 偽が発生した場合は \(T_k\) を \(V_i < T_k\) で条件付けして更新します。
- 真が発生した場合は状態を \(k+1\) に遷移させ、しきい値分布を基底しきい値にリセットします。

## 4. 出力変数の分布 (Condition)

- 各ステップ \(i\) の出力 \(Y_i\) を次の離散分布で表現します。
  - 値が 1: まだ \(c\) 回未満の真が出力されており、比較が真だった場合。
  - 値が 0: まだ \(c\) 回未満の真が出力されており、比較が偽だった場合。
  - 値が \(-1\): 既に \(c\) 回真を出してアボートしている場合。
- `Dist.from_atoms` で `[ (1, p_1), (0, p_0), (-1, p_{\mathrm{abort}}) ]` を構成し正規化します。

## 5. 状態遷移の追跡

- \(\text{state\_probs}[k]\) を「これまでに \(k\) 回真を出力した確率」として保持します。
- 比較結果が偽なら同じ状態 \(k\) に、真なら \(k+1\) に質量を移動し、\(k=c\) でアボートします。
- 各状態に対応するしきい値分布も同様に更新します。

以上により、各クエリの周辺分布は `svt2_joint_dist` から導出できます。

### 数値精度について

実装ではしきい値分布を有限個の格子点で近似しており、格子点数
`grid_size` により精度と計算コストのトレードオフが決まります。
`svt2_joint_dist` の引数 `grid_size` を大きくすることで、
理想的な分布との誤差を抑えられます。

## 6. 出力ベクトルのジョイント分布とプライバシー損失

`svt2_joint_dist` は出力ベクトルを逐次的に列挙し、真を出力した後はしきい値分布をリセットしつつ状態を更新します。`estimate_algorithm` に `joint_dist_func=svt2_joint_dist` を渡すことで、依存関係を考慮したプライバシー損失を評価でき、単純合計よりも小さい ε が得られます。
