# SVT2の確率分布計算

このドキュメントでは Sparse Vector Technique 2 (SVT2) の各出力確率変数の分布を解析的に求める手順を説明します。SVT2 はしきい値と各クエリ値にラプラスノイズを加えて比較し、真を出力した場合はしきい値を再サンプリングして最大 \(c\) 回まで真を返します。

## 1. しきい値分布の初期化 (Add)

- ノイズ \(\rho_0 \sim \mathrm{Lap}(c/\varepsilon_1)\) を生成します。
- 定数しきい値 \(t\) と加算し、\(T = t + \rho_0\) の分布を `add_distributions` で求めます。
- 真を出力した後に使用するため、\(\rho' \sim \mathrm{Lap}(c/\varepsilon_2)\) も準備し、\(t + \rho'\) の分布を保持します。

## 2. クエリ値分布 (Add)

- 各クエリ値 \(q_i\) に独立なノイズ \(\xi_i \sim \mathrm{Lap}(2c/\varepsilon_2)\) を加えます。
- `add_distributions` により \(V_i = q_i + \xi_i\) の分布を計算します。

## 3. しきい値比較 (CompareGEQ)

- しきい値分布と各 \(V_i\) の分布を `compare_geq` に渡すことで、真偽の確率を得ます。
- 真となる確率は \(P(V_i \geq T)\)、偽となる確率は \(1 - P(V_i \geq T)\) です。

## 4. 出力変数の分布 (Condition)

- 各ステップ \(i\) の出力 \(Y_i\) は以下の離散分布で表します。
  - 値が 1: まだ \(c\) 回未満の真が出力されており、比較が真だった場合。
  - 値が 0: まだ \(c\) 回未満の真が出力されており、比較が偽だった場合。
  - 値が \(-1\): 既に \(c\) 回真を出してアボートしている場合。
- `Dist.from_atoms` で `[ (1, p_1), (0, p_0), (-1, p_{\mathrm{abort}}) ]` を構成し、正規化します。

## 5. しきい値のリセットと状態更新

- \(\text{count\_probs}[k]\) を「これまでに \(k\) 回真を出力した確率」として保持します。
- 比較結果が真なら \(k+1\) に質量を移動し、その際しきい値分布を \(t + \rho'\) にリセットします。
- 比較結果が偽なら同じ状態 \(k\) に留まり、しきい値分布も保持します。\(k=c\) に到達すると以降の出力は \(-1\) となります。

以上により、各クエリの周辺分布は `svt2_joint_dist` から導出できます。

## 6. 出力ベクトルのジョイント分布とプライバシー損失

`svt2_joint_dist` は出力ベクトルを逐次的に列挙し、真を出力した後はしきい値分布をリセットしつつ状態を更新します。`estimate_algorithm` に `joint_dist_func=svt2_joint_dist` を渡すことで、依存関係を考慮したプライバシー損失を評価でき、単純合計よりも小さい ε が得られます。

