# SVT1の確率分布計算

このドキュメントでは Sparse Vector Technique 1 (SVT1) の各出力確率変数の分布をどのように解析的に求めているかを詳述します。SVT1 はしきい値にラプラスノイズを加え、各クエリ値にもノイズを加えて比較し、最大 c 回まで真を出力します。

## 1. しきい値分布 (Add)

- ノイズ \(\rho \sim \mathrm{Lap}(1/\varepsilon_1)\) を生成します。
- 定数のしきい値 \(t\) を `Dist.deterministic` で表現し、`add_distributions` で \(T = t + \rho\) の分布を計算します。
- 結果の確率密度関数は次式になります。
  \[ f_T(z) = \frac{\varepsilon_1}{2} \exp\left(-\varepsilon_1 |z - t|\right) \]

## 2. クエリ値分布 (Add)

- 各クエリ値 \(q_i\) に独立なノイズ \(\xi_i \sim \mathrm{Lap}(2c/\varepsilon_2)\) を加えます。
- `add_distributions` により \(V_i = q_i + \xi_i\) の分布を求めます。
- 確率密度関数は次式になります。
  \[ f_{V_i}(z) = \frac{\varepsilon_2}{4c} \exp\left(-\frac{\varepsilon_2}{2c} |z - q_i|\right) \]

## 3. しきい値比較 (CompareGEQ)

- `compare_geq` Operation は独立な \(V_i\) と \(T\) の分布を受け取り、二値分布を出力します。
- 真となる確率は
  \[ P(V_i \geq T) = \int_{-\infty}^{\infty} f_{V_i}(x) F_T(x) \, dx \]
  で計算されます。
- 偽となる確率は \(1 - P(V_i \geq T)\) です。

## 4. 出力変数の分布 (Condition)

- 各ステップ \(i\) の出力 \(Y_i\) は以下の離散分布で表します。
  - 値が 1: まだ \(c\) 回未満の真が出力されており、比較が真だった場合。
  - 値が 0: まだ \(c\) 回未満の真が出力されており、比較が偽だった場合。
  - 値が \(-1\): 既に \(c\) 回真を出してアボートしている場合。
- `Dist.from_atoms` で `[ (1, p_1), (0, p_0), (-1, p_{\mathrm{abort}}) ]` を構成し、正規化します。

## 5. 真の出力回数の更新

- \(\text{count\_probs}[k]\) を「これまでに \(k\) 回真を出力した確率」として保持します。
- 比較結果が真なら \(k+1\)、偽なら \(k\) に質量を移動し、\(k\) の上限は \(c\) にクリップします。
- この更新によりアボート状態の確率も適切に蓄積されます。

以上により、`svt1_dist` 関数では各クエリに対応する `Dist` オブジェクトのリストとして SVT1 の出力分布が得られます。

## 6. 出力ベクトルのジョイント分布とプライバシー損失

`svt1_dist` は各クエリの周辺分布を返すため、プライバシー損失を求める際に
単純に各座標の ε を足し合わせると依存関係を無視して過大評価してしまいます。

この問題を解決するために `svt1_joint_dist` 関数を導入しました。これは各クエリ
結果を逐次的に列挙し、機構が停止した後の要素には `-1` を挿入して、出力
ベクトル全体の確率分布を構成します。`estimate_algorithm` に
`joint_dist_func=svt1_joint_dist` を渡すことで、依存性を考慮した
プライバシー損失が計算され、座標ごとの単純合計よりも小さい値になります。
